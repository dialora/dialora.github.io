<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>BioCipher True Hardware Key (PRF)</title>
    <style>
        body { font-family: monospace; padding: 20px; max-width: 600px; margin: 0 auto; }
        input, button { font-size: 16px; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; }
        #log { background: #f0f0f0; padding: 10px; border: 1px solid #ccc; margin-top: 20px; white-space: pre-wrap; word-break: break-all;}
        .warn { color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; padding: 10px; margin-bottom: 10px;}
    </style>
</head>
<body>

    <h3>üõ°Ô∏è True Hardware Key (PRF Mode)</h3>
    <div class="warn">
        –í–Ω–∏–º–∞–Ω–∏–µ: –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è "PRF" (Chrome 115+, macOS TouchID –∏–ª–∏ Windows Hello). –ö–ª—é—á –ù–ï —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ, –æ–Ω –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–∏–ø–æ–º.
    </div>

    <h3>1. –î–∞–Ω–Ω—ã–µ</h3>
    <input type="text" id="secretInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–ø–µ—Ä-—Å–µ–∫—Ä–µ—Ç (123)">
    
    <h3>2. –î–µ–π—Å—Ç–≤–∏—è</h3>
    <button onclick="enrollAndEncrypt()">üëÜ –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á —á–∏–ø–æ–º –∏ –ó–ê–®–ò–§–†–û–í–ê–¢–¨</button>
    <button onclick="decryptWithHardwareKey()">üëÜ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á —á–∏–ø–æ–º –∏ –†–ê–°–®–ò–§–†–û–í–ê–¢–¨</button>
    <button onclick="clearAll()">‚ùå –°–±—Ä–æ—Å</button>

    <h3>3. –õ–æ–≥</h3>
    <div id="log">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <script>
        const STORAGE_KEY = 'prf_secured_container';

        function log(msg) { 
            document.getElementById('log').innerText += msg + "\n\n"; 
            console.log(msg);
        }
        function clearLog() { document.getElementById('log').innerText = ""; }

        // --- –ì–õ–ê–í–ù–ê–Ø –ú–ê–ì–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–∞ –∏–∑ –∂–µ–ª–µ–∑–∞ ---
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ "prf". –ú—ã —à–ª–µ–º —Å–æ–ª—å, —á–∏–ø –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—ã—Ä—ã–µ –±–∞–π—Ç—ã –∫–ª—é—á–∞.
        async function getHardwareKey(credentialId, salt) {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Å–æ–ª—å –≤ Uint8Array
            const saltBytes = new Uint8Array(salt);

            // –û–ø—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —á–∏–ø—É
            const publicKey = {
                challenge: window.crypto.getRandomValues(new Uint8Array(32)),
                rpId: location.hostname,
                userVerification: "required",
                // –ï—Å–ª–∏ –º—ã —É–∂–µ –∑–Ω–∞–µ–º ID (–ø—Ä–∏ –≤—Ö–æ–¥–µ), —É–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                allowCredentials: credentialId ? [{
                    type: 'public-key',
                    id: credentialId,
                    transports: ['internal']
                }] : [],
                // –ó–ê–ü–†–û–° PRF: –ü—Ä–æ—Å–∏–º —á–∏–ø –≤—ã—á–∏—Å–ª–∏—Ç—å —Å–µ–∫—Ä–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–ª–∏
                extensions: {
                    prf: {
                        eval: {
                            first: saltBytes
                        }
                    }
                }
            };

            const assertion = await navigator.credentials.get({ publicKey });
            
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è PRF
            const extensions = assertion.getClientExtensionResults();
            if (!extensions.prf || !extensions.prf.results || !extensions.prf.results.first) {
                throw new Error("–í–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç PRF (–∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏). –ö–ª—é—á –Ω–µ –ø–æ–ª—É—á–µ–Ω.");
            }

            // –≠—Ç–æ —Å—ã—Ä–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª –∫–ª—é—á–∞, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–Ω—É—Ç—Ä–∏ —á–∏–ø–∞ TouchID/FaceID
            const inputKeyMaterial = new Uint8Array(extensions.prf.results.first);
            
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º —Å—ã—Ä—ã–µ –±–∞–π—Ç—ã –≤ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫—Ä–∏–ø—Ç–æ-–∫–ª—é—á AES-GCM —á–µ—Ä–µ–∑ HKDF
            // (–≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ "–æ—á–∏—Å—Ç–∫–∏" –∫–ª—é—á–∞)
            const keyDerivationKey = await window.crypto.subtle.importKey(
                "raw", inputKeyMaterial, "HKDF", false, ["deriveKey"]
            );

            const aesKey = await window.crypto.subtle.deriveKey(
                {
                    name: "HKDF",
                    hash: "SHA-256",
                    salt: new Uint8Array(), // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                    info: new TextEncoder().encode("BioCipher Encryption") 
                },
                keyDerivationKey,
                { name: "AES-GCM", length: 256 },
                true,
                ["encrypt", "decrypt"]
            );

            return { 
                key: aesKey, 
                credentialId: new Uint8Array(assertion.rawId) 
            };
        }


        // --- 1. –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø + –®–ò–§–†–û–í–ê–ù–ò–ï ---
        async function enrollAndEncrypt() {
            clearLog();
            const secret = document.getElementById('secretInput').value;
            if (!secret) return alert('–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!');

            try {
                log("1. –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É –∫–ª—é—á–µ–π –≤ –±–∏–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–æ–º –º–æ–¥—É–ª–µ...");
                
                // –®–∞–≥ A: –°–æ–∑–¥–∞–µ–º Credential (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–∞–ª—å—Ü–∞)
                // –ù–∞–º –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å PRF –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏
                const createOptions = {
                    publicKey: {
                        challenge: window.crypto.getRandomValues(new Uint8Array(32)),
                        rp: { name: "BioCipher PRF", id: location.hostname },
                        user: { 
                            id: window.crypto.getRandomValues(new Uint8Array(16)), 
                            name: "user@prf", 
                            displayName: "PRF User" 
                        },
                        pubKeyCredParams: [{ alg: -7, type: "public-key" }],
                        authenticatorSelection: { userVerification: "required", authenticatorAttachment: "platform" },
                        timeout: 60000,
                        // –í–∫–ª—é—á–∞–µ–º PRF —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
                        extensions: { prf: {} }
                    }
                };

                const newCred = await navigator.credentials.create(createOptions);
                const credId = new Uint8Array(newCred.rawId);
                
                log("2. –ë–∏–æ–º–µ—Ç—Ä–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω–∞. –¢–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...");
                
                // –®–∞–≥ B: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Å–æ–ª—å –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
                const fileSalt = window.crypto.getRandomValues(new Uint8Array(32));

                // –®–∞–≥ C: –°—Ä–∞–∑—É –∂–µ –ø—Ä–æ—Å–∏–º —á–∏–ø –≤—ã—á–∏—Å–ª–∏—Ç—å –∫–ª—é—á –¥–ª—è —ç—Ç–æ–π —Å–æ–ª–∏.
                // (–ò–Ω–æ–≥–¥–∞ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Å—Ä–∞–∑—É –ø—Ä–∏ create, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ –≤—ã–∑–≤–∞—Ç—å get)
                const { key: hardwareKey } = await getHardwareKey(credId, fileSalt);

                log("3. –ö–ª—é—á –ø–æ–ª—É—á–µ–Ω –∏–∑ —á–∏–ø–∞ (–≤ –ø–∞–º—è—Ç–∏). –®–∏—Ñ—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ...");

                // –®–∞–≥ D: –®–∏—Ñ—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ —ç—Ç–∏–º –∫–ª—é—á–æ–º
                const iv = window.crypto.getRandomValues(new Uint8Array(12));
                const encodedData = new TextEncoder().encode(secret);
                const encryptedData = await window.crypto.subtle.encrypt(
                    { name: "AES-GCM", iv: iv },
                    hardwareKey,
                    encodedData
                );

                // –®–∞–≥ E: –°–æ—Ö—Ä–∞–Ω—è–µ–º. 
                // –í–ê–ñ–ù–û: –ú—ã –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º Key. –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º CredentialID –∏ Salt.
                // –ë–µ–∑ –ø–∞–ª—å—Ü–∞ Salt –±–µ—Å–ø–æ–ª–µ–∑–Ω–∞.
                const dbRecord = {
                    ciphertext: arrayBufferToBase64(encryptedData),
                    iv: arrayBufferToBase64(iv),
                    salt: arrayBufferToBase64(fileSalt),
                    credId: arrayBufferToBase64(credId)
                };

                localStorage.setItem(STORAGE_KEY, JSON.stringify(dbRecord));
                document.getElementById('secretInput').value = "";
                
                log("–£–°–ü–ï–•! –í LocalStorage —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —Ç–æ–ª—å–∫–æ:\n1. –®–∏—Ñ—Ä\n2. –°–æ–ª—å\n3. ID –ø–∞–ª—å—Ü–∞\n–ö–õ–Æ–ß –ù–ï –°–û–•–†–ê–ù–ï–ù!");

            } catch (e) {
                log("–û–®–ò–ë–ö–ê: " + e.message);
                console.error(e);
            }
        }

        // --- 2. –†–ê–°–®–ò–§–†–û–í–ö–ê ---
        async function decryptWithHardwareKey() {
            clearLog();
            const recordStr = localStorage.getItem(STORAGE_KEY);
            if (!recordStr) return log("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.");
            const record = JSON.parse(recordStr);

            try {
                log("1. –ß–∏—Ç–∞–µ–º —Å–æ–ª—å –∏–∑ –±–∞–∑—ã. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–ª—é—á —É —á–∏–ø–∞...");
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±—É—Ñ–µ—Ä—ã
                const salt = base64ToArrayBuffer(record.salt);
                const credId = base64ToArrayBuffer(record.credId);
                const iv = base64ToArrayBuffer(record.iv);
                const ciphertext = base64ToArrayBuffer(record.ciphertext);

                // –°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç: –ú—ã –æ—Ç–¥–∞–µ–º –°–æ–ª—å + –ü–∞–ª–µ—Ü -> –ü–æ–ª—É—á–∞–µ–º –ö–ª—é—á
                const { key: hardwareKey } = await getHardwareKey(credId, salt);

                log("2. –ß–∏–ø –≤–µ—Ä–Ω—É–ª –∫–ª—é—á. –ü—Ä–æ–±—É–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å...");

                const decryptedBuffer = await window.crypto.subtle.decrypt(
                    { name: "AES-GCM", iv: iv },
                    hardwareKey,
                    ciphertext
                );

                const result = new TextDecoder().decode(decryptedBuffer);
                document.getElementById('secretInput').value = result;
                log("–£–°–ü–ï–•! –î–∞–Ω–Ω—ã–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã.");

            } catch (e) {
                log("–û–®–ò–ë–ö–ê: " + e.message);
                if (e.name === "OperationError") {
                    log("–í–µ—Ä–æ—è—Ç–Ω–æ, —á–∏–ø –≤–µ—Ä–Ω—É–ª –Ω–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á (–¥—Ä—É–≥–æ–π –ø–∞–ª–µ—Ü?) –∏–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã.");
                }
            }
        }

        function clearAll() {
            localStorage.clear();
            document.getElementById('secretInput').value = "";
            clearLog();
            log("–ë–∞–∑–∞ –æ—á–∏—â–µ–Ω–∞.");
        }

        // --- Helpers ---
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
            return window.btoa(binary);
        }

        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
            return bytes.buffer;
        }
    </script>
</body>
</html>
