<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç PWA File System</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        textarea { width: 100%; height: 200px; margin-top: 10px; font-size: 14px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #status { margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 4px; color: #333; }
        .hidden { display: none; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>

    <h1>üìù –†–µ–¥–∞–∫—Ç–æ—Ä mytest.txt</h1>

    <div id="controls">
        <button id="btn-pick" onclick="pickNewFile()">üìÇ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª (–ü–µ—Ä–≤—ã–π —Ä–∞–∑)</button>
        <button id="btn-reopen" class="hidden" onclick="reopenSavedFile()">üîÑ –û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª (–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å)</button>
    </div>

    <div id="editor-area" class="hidden">
        <p>–¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª: <b id="filename-display">...</b></p>
        <textarea id="content-area" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea>
        <br>
        <button onclick="saveChanges()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        <button onclick="clearDb()">‚ùå –ó–∞–±—ã—Ç—å —Ñ–∞–π–ª</button>
    </div>

    <div id="status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <script>
        let fileHandle;
        const DB_NAME = 'TextEditorDB';
        const STORE_NAME = 'fileHandles';

        // --- 1. –†–∞–±–æ—Ç–∞ —Å IndexedDB (—á—Ç–æ–±—ã –ø–æ–º–Ω–∏—Ç—å —Ñ–∞–π–ª) ---
        const dbPromise = new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, 1);
            req.onupgradeneeded = () => req.result.createObjectStore(STORE_NAME);
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });

        async function saveHandleToDb(handle) {
            const db = await dbPromise;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(handle, 'mytest_file');
            return new Promise(resolve => tx.oncomplete = resolve);
        }

        async function getHandleFromDb() {
            const db = await dbPromise;
            return new Promise(resolve => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const req = tx.objectStore(STORE_NAME).get('mytest_file');
                req.onsuccess = () => resolve(req.result);
            });
        }

        // --- 2. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ---

        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        window.addEventListener('DOMContentLoaded', async () => {
            const handle = await getHandleFromDb();
            if (handle) {
                log(`–ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª: "${handle.name}". –ù–∞–∂–º–∏—Ç–µ "–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª", —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.`);
                document.getElementById('btn-pick').classList.add('hidden'); // –ü—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ –Ω–æ–≤–æ–≥–æ
                document.getElementById('btn-reopen').classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
                fileHandle = handle;
            } else {
                log("–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞.");
            }
        });

        // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç —Ñ–∞–π–ª –ø–µ—Ä–≤—ã–π —Ä–∞–∑
        async function pickNewFile() {
            try {
                // –§–∏–ª—å—Ç—Ä —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'Text Files', accept: { 'text/plain': ['.txt'] } }],
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                await saveHandleToDb(fileHandle);
                
                log(`–§–∞–π–ª "${fileHandle.name}" –≤—ã–±—Ä–∞–Ω –∏ –∑–∞–ø–æ–º–Ω–µ–Ω!`, true);
                enableEditor();
                loadFileContent();
            } catch (err) {
                log("–í—ã–±–æ—Ä —Ñ–∞–π–ª–∞ –æ—Ç–º–µ–Ω–µ–Ω.", false, true);
                console.error(err);
            }
        }

        // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–µ—Ä–Ω—É–ª—Å—è –∏ –Ω–∞–∂–∞–ª "–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª"
        async function reopenSavedFile() {
            if (!fileHandle) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞. –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç ‚Äî –±—Ä–∞—É–∑–µ—Ä —Å–ø—Ä–æ—Å–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            // mode: 'readwrite' –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –±–µ–∑ –≤–æ–ø—Ä–æ—Å–æ–≤
            const options = { mode: 'readwrite' };
            
            if ((await fileHandle.queryPermission(options)) === 'granted') {
                log("–î–æ—Å—Ç—É–ø –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.");
                enableEditor();
                loadFileContent();
                return;
            }

            // –ï—Å–ª–∏ –ø—Ä–∞–≤ –Ω–µ—Ç, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º (–ø–æ—è–≤–∏—Ç—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ –æ–∫–æ—à–∫–æ)
            if ((await fileHandle.requestPermission(options)) === 'granted') {
                log("–î–æ—Å—Ç—É–ø –ø–æ–ª—É—á–µ–Ω!");
                enableEditor();
                loadFileContent();
            } else {
                log("–í –¥–æ—Å—Ç—É–ø–µ –æ—Ç–∫–∞–∑–∞–Ω–æ. –ù–µ –º–æ–≥—É –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª.", false, true);
            }
        }

        // –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        async function loadFileContent() {
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                document.getElementById('content-area').value = text;
                document.getElementById('filename-display').textContent = file.name;
                log("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ñ–∞–π–ª–∞.");
            } catch (err) {
                log("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: " + err, false, true);
            }
        }

        // –ó–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö (–°–æ—Ö—Ä–∞–Ω–∏—Ç—å)
        async function saveChanges() {
            if (!fileHandle) return;
            try {
                log("–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...");
                const writable = await fileHandle.createWritable();
                const content = document.getElementById('content-area').value;
                await writable.write(content);
                await writable.close();
                log("‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!", true);
            } catch (err) {
                log("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + err, false, true);
            }
        }

        // –°–±—Ä–æ—Å (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
        async function clearDb() {
            const db = await dbPromise;
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete('mytest_file');
            await new Promise(resolve => tx.oncomplete = resolve);
            location.reload();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function enableEditor() {
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('editor-area').classList.remove('hidden');
        }

        function log(msg, success = false, error = false) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = success ? 'success' : (error ? 'error' : '');
        }
    </script>
</body>
</html>
